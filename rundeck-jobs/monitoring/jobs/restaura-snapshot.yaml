- defaultTab: output
  description: 'Restaura snapshot '
  executionEnabled: true
  id: restaura-targets
  loglevel: INFO
  name: 'Restaura snapshot '
  nodeFilterEditable: false
  options:
  - description: Chave de API da MGC
    name: MGCAPIKEY
    required: true
    secure: true
    storagePath: keys/project/monitoring/MGCAPIKEY
    valueExposed: true
  plugins:
    ExecutionLifecycle: {}
  scheduleEnabled: true
  sequence:
    commands:
    - autoSecureInput: 'false'
      passSecureInput: 'false'
      script: |-
        #!/bin/bash

        set -e

        export MGC_AUTH_TYPE=api-key
        API_KEY=$RD_OPTION_MGCAPIKEY  # Ou defina manualmente se n√£o estiver rodando no Rundeck
        SSH_KEY="managed-services"
        MACHINE_TYPE_ID="0122fb85-0fd0-47d1-bf25-f24ca6f11493"

        # Gera nome √∫nico para a VM restaurada
        SUFFIX=$(date +%s)
        VM_NAME="app-$SUFFIX"

        # Busca snapshot com nome contendo "app-"
        SNAPSHOT_ID=$(mgc virtual-machine snapshots list --api-key="$API_KEY" --output json | \
          sed 's/\x1B\[[0-9;]*[mK]//g' | \
          jq -r '.snapshots[] | select(.name | test("app-")) | .id' | head -n 1)

        if [ -z "$SNAPSHOT_ID" ]; then
          echo "‚ùå Nenhum snapshot com 'app-' encontrado."
          exit 1
        fi

        echo "üì¶ Snapshot selecionado: $SNAPSHOT_ID"
        echo "üöÄ Restaurando com nome: $VM_NAME"

        mgc virtual-machine snapshots restore \
          --name="$VM_NAME" \
          --id="$SNAPSHOT_ID" \
          --ssh-key-name="$SSH_KEY" \
          --machine-type.id="$MACHINE_TYPE_ID" \
          --api-key="$API_KEY"
    keepgoing: false
    strategy: node-first
  uuid: restaura-targets
