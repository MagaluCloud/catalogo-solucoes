- defaultTab: output
  description: "Varre o ambiente procurando por VMs que tenhham APP no nome, deleta\
    \ e atualiza os n√≥s do Grafana \n"
  executionEnabled: true
  id: remove-instances-and-update-grafana
  loglevel: INFO
  name: Remove-instances-and-update-grafana
  nodeFilterEditable: false
  options:
  - description: Chave de API da MGC
    name: MGCAPIKEY
    required: true
    secure: true
    storagePath: keys/project/monitoring/MGCAPIKEY
    valueExposed: true
  plugins:
    ExecutionLifecycle: {}
  scheduleEnabled: true
  sequence:
    commands:
    - autoSecureInput: 'false'
      passSecureInput: 'false'
      script: |-
        #!/bin/bash
        set -e

        export MGC_AUTH_TYPE=api-key
        API_KEY="$RD_OPTION_MGCAPIKEY"
        TARGET_FILE="/etc/prometheus/hosts_app.yml"
        TMP_FILE="/tmp/hosts_app.tmp.yml"

        #######################################
        # 1. Deleta inst√¢ncias com nome app-<n√∫mero>
        #######################################

        echo "üîç Buscando inst√¢ncias com padr√£o 'app-<n√∫mero>'..."

        INSTANCE_IDS=$(mgc virtual-machine instances list --api-key="$API_KEY" --output json | \
          sed 's/\x1B\[[0-9;]*[mK]//g' | \
          jq -r '.instances[] | select(.name | test("^app-[0-9]+$")) | .id')

        if [[ -z "$INSTANCE_IDS" ]]; then
          echo "‚ÑπÔ∏è Nenhuma inst√¢ncia encontrada com o padr√£o 'app-<n√∫mero>'."
        else
          echo "üóëÔ∏è Deletando as seguintes inst√¢ncias:"
          echo "$INSTANCE_IDS"
          echo

          for ID in $INSTANCE_IDS; do
            echo "üîª Deletando inst√¢ncia: $ID"
            mgc virtual-machine instances delete --id="$ID" --no-confirm --api-key="$API_KEY"
          done
          echo "‚úÖ Inst√¢ncias removidas."
        fi

        #######################################
        # 2. Atualiza o arquivo de targets do Prometheus
        #######################################

        echo
        echo "üîç Buscando portas com nome contendo 'app-'..."

        IPS=$(mgc network ports list --api-key="$API_KEY" --output json | \
          sed 's/\x1B\[[0-9;]*[mK]//g' | \
          jq -r '.[] | select(.name | test("app-")) | .ip_address[]? | select(.ethertype == "IPv4") | .ip_address')

        if [ -z "$IPS" ]; then
          echo "‚ùå Nenhum IP encontrado para portas com nome app-*"
          exit 1
        fi

        echo "üìÑ Gerando novo arquivo de targets: $TMP_FILE"
        echo "- targets:" > "$TMP_FILE"
        for IP in $IPS; do
          echo "  - \"$IP:9100\"" >> "$TMP_FILE"
        done
        echo "  labels:" >> "$TMP_FILE"
        echo "    job: node_exporter" >> "$TMP_FILE"

        echo "üì¶ Atualizando $TARGET_FILE..."
        sudo cp "$TMP_FILE" "$TARGET_FILE"
        sudo chown prometheus:prometheus "$TARGET_FILE"
        rm -f "$TMP_FILE"

        echo "üîÅ Reiniciando Prometheus..."
        sudo systemctl restart prometheus

        echo "‚úÖ Conclu√≠do. Acesse http://localhost:9090/targets para verificar os alvos atualizados."
    keepgoing: false
    strategy: node-first
  uuid: remove-instances-and-update-grafana
